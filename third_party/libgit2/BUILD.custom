load("@rules_cc//cc:defs.bzl", "cc_library")

cc_library(
    name = "http_parser",
    srcs = ["deps/http-parser/http_parser.c"],
    hdrs = ["deps/http-parser/http_parser.h"],
    includes = ["deps/http-parser/"],
)

cc_library(
    name = "headers",
    hdrs = glob([
        "src/*.h",
        "include/git2/**/*.h",
    ]),
    includes = ["include"],
)

cc_library(
    name = "pcre",
    srcs = glob(["deps/pcre/*.c"]),
    hdrs = glob(["deps/pcre/*.h"]),
    copts = [
        "-DSTDC=1",
    ],
    includes = [
        "deps/pcre",
    ],
    deps = [
        ":headers",
        "@monorepo//third_party/libgit2/pcre:config",
    ],
)

cc_library(
    name = "zlib",
    srcs = glob(["deps/zlib/*.c"]),
    hdrs = glob(["deps/zlib/*.h"]),
    copts = [
        "-DSTDC=1",
    ],
    includes = [
        "deps/zlib",
    ],
    deps = [
        ":headers",
    ],
)

cc_library(
    name = "libgit2",
    srcs = glob(
        [
            "src/libgit2/*.c",
            "src/libgit2/*.h",
            "src/libgit2/hash/hash_collisiondetect.h",
            "src/libgit2/hash/hash_common_crypto.h",
            "src/libgit2/hash/sha1dc/*.c",
            "src/libgit2/hash/sha1dc/*.h",
            "src/libgit2/unix/*.c",
            "src/libgit2/unix/*.h",
            "src/libgit2/transports/*.c",
            "src/libgit2/transports/*.h",
            "src/libgit2/xdiff/*.h",
            "src/libgit2/xdiff/*.c",
            "src/libgit2/streams/*.h",
            "src/libgit2/streams/*.c",
            "src/util/*.h",
            "src/util/*.c",
            "src/util/hash/*.h",
            "src/util/hash/*.c",
            "src/util/hash/sha1dc/*.h",
            "src/util/hash/sha1dc/*.c",
            "src/util/hash/rfc6234/*.h",
            "src/util/hash/rfc6234/*.c",
            "src/util/unix/*.h",
            "src/util/unix/*.c",
            "src/util/allocators/*.h",
            "src/util/allocators/*.c",
        ],
        exclude = [
            "src/libgit2/transports/winhttp.c",
        ],
    ) + [
    ],
    hdrs = glob(["include/**/*.h"]),
    copts = [
        "-Iexternal/com_github_libgit2/src/libgit2",
        "-Iexternal/com_github_libgit2/src/util",
        "-Wno-unused-function",
    ],
    visibility = ["//visibility:public"],
    deps = [
        ":headers",
        ":http_parser",
        ":zlib",
        ":pcre",
        "@monorepo//third_party/libgit2:features",
    ],
)

